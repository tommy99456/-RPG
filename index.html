<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»ä¹‹ç‰¹å·¥éšŠï¼šåƒç´ æˆ°è¨˜</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-950 text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- æ ¸å¿ƒä¿®å¾©ï¼šå®‰å…¨çš„ Icon Wrapper ---
        const IconWrapper = ({ name, size = 24, className }) => {
            const ref = useRef(null);

            useEffect(() => {
                if (ref.current && window.lucide && window.lucide.icons[name]) {
                    ref.current.innerHTML = '';
                    const svg = window.lucide.createElement(window.lucide.icons[name]);
                    svg.setAttribute('width', size);
                    svg.setAttribute('height', size);
                    if (className) {
                        svg.setAttribute('class', className);
                    }
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);

            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }} />;
        };

        // --- å®šç¾©æ‰€æœ‰ç”¨åˆ°çš„åœ–ç¤º ---
        const Zap = (p) => <IconWrapper name="zap" {...p} />;
        const Shield = (p) => <IconWrapper name="shield" {...p} />;
        const Settings = (p) => <IconWrapper name="settings" {...p} />;
        const AlertTriangle = (p) => <IconWrapper name="alert-triangle" {...p} />;
        const Crosshair = (p) => <IconWrapper name="crosshair" {...p} />;
        const Package = (p) => <IconWrapper name="package" {...p} />;
        const Trophy = (p) => <IconWrapper name="trophy" {...p} />;
        const RotateCcw = (p) => <IconWrapper name="rotate-ccw" {...p} />;
        const Flame = (p) => <IconWrapper name="flame" {...p} />;
        const Lightbulb = (p) => <IconWrapper name="lightbulb" {...p} />;
        const Magnet = (p) => <IconWrapper name="magnet" {...p} />;
        const CheckCircle = (p) => <IconWrapper name="check-circle" {...p} />;
        const XCircle = (p) => <IconWrapper name="x-circle" {...p} />;
        const Lock = (p) => <IconWrapper name="lock" {...p} />;
        const Unlock = (p) => <IconWrapper name="unlock" {...p} />;
        const ArrowRight = (p) => <IconWrapper name="arrow-right" {...p} />;
        const BrainCircuit = (p) => <IconWrapper name="brain-circuit" {...p} />;
        const Activity = (p) => <IconWrapper name="activity" {...p} />;
        const Terminal = (p) => <IconWrapper name="terminal" {...p} />;
        const Sparkles = (p) => <IconWrapper name="sparkles" {...p} />;
        const Frown = (p) => <IconWrapper name="frown" {...p} />;
        const Star = (p) => <IconWrapper name="star" {...p} />;
        const ZapOff = (p) => <IconWrapper name="zap-off" {...p} />;
        const HeartPulse = (p) => <IconWrapper name="heart-pulse" {...p} />;
        const Wind = (p) => <IconWrapper name="wind" {...p} />;
        const Sword = (p) => <IconWrapper name="sword" {...p} />;
        const Target = (p) => <IconWrapper name="target" {...p} />;
        const Battery = (p) => <IconWrapper name="battery" {...p} />;
        const Cpu = (p) => <IconWrapper name="cpu" {...p} />;

        // --- ğŸ¨ åƒç´ é¢¨ SVG åœ–åƒè³‡æº ---
        const PixelSvg = ({ children, className }) => (
          <svg viewBox="0 0 24 24" className={`w-full h-full ${className}`} shapeRendering="crispEdges">
            {children}
          </svg>
        );

        // å¯¶ç‰©åœ–ç¤º
        const PixelTreasureMagnet = () => (
            <PixelSvg>
                <path d="M4 8 L4 16 A 8 8 0 0 0 20 16 L 20 8 L 16 8 L 16 16 A 4 4 0 0 1 8 16 L 8 8 Z" fill="#06b6d4" />
                <rect x="4" y="4" width="4" height="4" fill="#cbd5e1" />
                <rect x="16" y="4" width="4" height="4" fill="#cbd5e1" />
            </PixelSvg>
        );

        const PixelTreasureFire = () => (
            <PixelSvg>
                <path d="M12 2 Q18 8 18 14 A 6 6 0 1 1 6 14 Q 6 8 12 2 Z" fill="#ea580c" />
                <circle cx="12" cy="15" r="3" fill="#fbbf24" className="animate-pulse" />
            </PixelSvg>
        );

        const PixelTreasureLight = () => (
            <PixelSvg>
                <polygon points="12,2 15,8 21,9 17,14 18,20 12,17 6,20 7,14 3,9 9,8" fill="#facc15" stroke="#ca8a04" strokeWidth="1" />
                <circle cx="12" cy="11" r="3" fill="#ffedd5" className="animate-ping" opacity="0.5" />
            </PixelSvg>
        );

        const AvatarEngineer = () => (
          <PixelSvg>
            <rect x="7" y="4" width="10" height="9" fill="#fca5a5" />
            <rect x="7" y="4" width="10" height="3" fill="#3b82f6" />
            <rect x="8" y="5" width="3" height="2" fill="#22d3ee" />
            <rect x="13" y="5" width="3" height="2" fill="#22d3ee" />
            <rect x="8" y="13" width="8" height="7" fill="#1e3a8a" />
            <rect x="6" y="13" width="2" height="6" fill="#93c5fd" />
            <rect x="16" y="13" width="2" height="6" fill="#93c5fd" />
            <rect x="17" y="16" width="6" height="2" fill="#475569" />
            <rect x="16" y="15" width="2" height="4" fill="#334155" />
          </PixelSvg>
        );

        const AvatarMage = () => (
          <PixelSvg>
            <rect x="8" y="5" width="8" height="8" fill="#fdba74" />
            <rect x="7" y="3" width="10" height="3" fill="#7c3aed" />
            <polygon points="8,3 16,3 12,0" fill="#7c3aed" />
            <rect x="7" y="13" width="10" height="8" fill="#db2777" />
            <rect x="9" y="13" width="6" height="8" fill="#fbcfe8" />
            <rect x="18" y="5" width="2" height="16" fill="#78350f" />
            <rect x="17" y="4" width="4" height="4" fill="#fbbf24" />
          </PixelSvg>
        );

        const AvatarWarrior = () => (
          <PixelSvg>
            <rect x="7" y="4" width="10" height="9" fill="#cbd5e1" /> 
            <rect x="11" y="5" width="2" height="8" fill="#475569" />
            <rect x="10" y="2" width="4" height="3" fill="#eab308" />
            <rect x="6" y="13" width="12" height="8" fill="#fbbf24" />
            <rect x="9" y="13" width="6" height="8" fill="#b45309" />
            <rect x="3" y="10" width="3" height="10" fill="#94a3b8" />
            <rect x="2" y="18" width="5" height="2" fill="#475569" />
          </PixelSvg>
        );

        const AvatarBoss = () => (
          <PixelSvg>
            <rect x="6" y="4" width="12" height="10" fill="#7f1d1d" /> 
            <rect x="8" y="7" width="3" height="3" fill="#ef4444" className="animate-pulse"/>
            <rect x="13" y="7" width="3" height="3" fill="#ef4444" className="animate-pulse"/>
            <rect x="4" y="14" width="16" height="8" fill="#1f2937" /> 
            <rect x="8" y="16" width="8" height="4" fill="#b91c1c" />
            <rect x="3" y="10" width="2" height="6" fill="#991b1b" />
            <rect x="19" y="10" width="2" height="6" fill="#991b1b" />
          </PixelSvg>
        );

        const AvatarUltimateBoss = () => (
          <PixelSvg>
            <rect x="2" y="2" width="20" height="20" fill="#581c87" opacity="0.3" className="animate-pulse" />
            <path d="M4 2 L8 8 L6 8 Z" fill="#facc15" />
            <path d="M20 2 L16 8 L18 8 Z" fill="#facc15" />
            <rect x="6" y="5" width="12" height="10" fill="#4c1d95" /> 
            <rect x="8" y="8" width="8" height="2" fill="#000000" />
            <rect x="9" y="8" width="2" height="2" fill="#ef4444" className="animate-ping" />
            <rect x="13" y="8" width="2" height="2" fill="#ef4444" className="animate-ping" />
            <rect x="3" y="15" width="18" height="8" fill="#2e1065" /> 
            <rect x="8" y="15" width="8" height="8" fill="#7e22ce" /> 
            <rect x="10" y="17" width="4" height="4" fill="#facc15" />
          </PixelSvg>
        );

        const WeaponRailgun = ({ level }) => (
          <svg viewBox="0 0 200 100" className="w-full h-full">
            <rect x="40" y="30" width="120" height="40" rx="5" fill="#1e293b" stroke="#06b6d4" strokeWidth="2" />
            <path d="M50 30 L50 70 M70 30 L70 70 M90 30 L90 70 M110 30 L110 70 M130 30 L130 70" stroke="#0e7490" strokeWidth="2" />
            {level > 1 && <rect x="45" y="45" width="110" height="10" fill="#22d3ee" className="animate-pulse" />}
            {level > 2 && <circle cx="160" cy="50" r="10" fill="#67e8f9" className="animate-ping" />}
            <rect x="20" y="40" width="20" height="20" fill="#334155" />
          </svg>
        );

        const WeaponStaff = ({ level }) => (
          <svg viewBox="0 0 200 100" className="w-full h-full">
            <rect x="20" y="45" width="160" height="10" rx="2" fill="#431407" />
            <circle cx="170" cy="50" r="15" fill="#c2410c" />
            {level > 1 && <circle cx="170" cy="50" r="10" fill="#f97316" className="animate-pulse" />}
            {level > 2 && (
              <g>
                <circle cx="170" cy="50" r="25" fill="none" stroke="#fbbf24" strokeWidth="2" className="animate-spin-slow" strokeDasharray="5,5" />
              </g>
            )}
          </svg>
        );

        const WeaponSaber = ({ level }) => (
          <svg viewBox="0 0 200 100" className="w-full h-full">
            <rect x="20" y="40" width="40" height="20" rx="2" fill="#3f3f46" stroke="#a1a1aa" />
            <path d="M60 50 L180 50" stroke="#eab308" strokeWidth="10" strokeLinecap="round" opacity="0.3" />
            {level > 0 && <path d="M60 50 L180 50" stroke="#facc15" strokeWidth="6" strokeLinecap="round" className="animate-pulse" />}
            {level > 2 && <path d="M60 50 L180 50" stroke="#fef08a" strokeWidth="2" strokeLinecap="round" />}
          </svg>
        );

        // --- Game Constants ---

        const CLASSES = [
          {
            id: 'engineer',
            name: 'æ©Ÿç”²å·¥ç¨‹å¸«',
            roleType: 'Magnetic',
            Avatar: AvatarEngineer,
            Weapon: WeaponRailgun,
            weaponName: 'è¶…é›»ç£åŠ è¾²ç ²',
            ultimateName: 'é‡å­è»Œé“è½Ÿç‚¸', 
            desc: 'æ“æ§ã€Œç£æ•ˆæ‡‰ã€çš„å¤§å¸«ã€‚åˆ©ç”¨ç·šåœˆå’ŒéµèŠ¯ï¼Œç”¢ç”Ÿå¼·å¤§çš„ç£åŠ›è¡æ“Šã€‚',
            color: 'text-cyan-400',
            borderColor: 'border-cyan-500',
            bg: 'bg-cyan-950/80',
            btnBg: 'bg-cyan-600 hover:bg-cyan-500',
            partName: 'è¶…å°ç·šåœˆ',
            partIcon: <Magnet size={32} />,
            activeColor: 'cyan'
          },
          {
            id: 'mage',
            name: 'ç«ç‚æ³•å¸«',
            roleType: 'Thermal',
            Avatar: AvatarMage,
            Weapon: WeaponStaff,
            weaponName: 'é«˜ç†±é›¢å­æ³•æ–',
            ultimateName: 'æœ«æ—¥é«˜ç†±é›·åŠ«',
            desc: 'ç²¾é€šã€Œç†±æ•ˆæ‡‰ã€çš„å¥§ç§˜ã€‚åˆ©ç”¨é«˜é›»é˜»ç™¼ç†±ç·šï¼Œé‡‹æ”¾ç¼ç†±çš„èƒ½é‡ã€‚',
            color: 'text-orange-400',
            borderColor: 'border-orange-500',
            bg: 'bg-orange-950/80',
            btnBg: 'bg-orange-600 hover:bg-orange-500',
            partName: 'é«˜é˜»ç™¼ç†±çµ²',
            partIcon: <Flame size={32} />,
            activeColor: 'orange'
          },
          {
            id: 'warrior',
            name: 'å…‰èƒ½æˆ°å£«',
            roleType: 'Luminous',
            Avatar: AvatarWarrior,
            Weapon: WeaponSaber,
            weaponName: 'å…‰å­é›·å°„åŠ',
            ultimateName: 'è¶…å…‰å­çˆ†è£‚æ–¬',
            desc: 'é§•é¦­ã€Œå…‰æ•ˆæ‡‰ã€çš„åŠ›é‡ã€‚åˆ©ç”¨ LED æ™¶é«”åŒ¯èšå…‰æŸï¼Œæ–¬æ–·é»‘æš—ã€‚',
            color: 'text-yellow-400',
            borderColor: 'border-yellow-500',
            bg: 'bg-yellow-950/80',
            btnBg: 'bg-yellow-600 hover:bg-yellow-500',
            partName: 'èšå…‰ LED æ™¶é«”',
            partIcon: <Lightbulb size={32} />,
            activeColor: 'yellow'
          }
        ];

        // ä½¿ç”¨æ–°çš„ Pixel SVG ä½œç‚ºå¯¶ç‰©åœ–ç¤º
        const TREASURES = [
          { type: 'Magnetic', name: 'è¶…å°ç·šåœˆçµ„ä»¶', desc: 'è˜Šå«å¼·å¤§ç£å ´æ½›åŠ›çš„ç²¾å¯†ç·šåœˆã€‚', icon: <PixelTreasureMagnet /> },
          { type: 'Thermal', name: 'é«˜é˜»ç™¼ç†±æ ¸å¿ƒ', desc: 'èƒ½ç¬é–“ç”¢ç”Ÿæ¥µé«˜æº«åº¦çš„æ ¸å¿ƒææ–™ã€‚', icon: <PixelTreasureFire /> },
          { type: 'Luminous', name: 'å…‰å­èšåˆæ™¶é«”', desc: 'èƒ½å¤ å°‡é›»èƒ½é«˜æ•ˆç‡è½‰åŒ–ç‚ºç´”æ·¨å…‰æŸã€‚', icon: <PixelTreasureLight /> }
        ];

        // --- é¡Œåº« (æ“´å……è‡³ 30 é¡Œ) ---
        const MASTER_QUESTION_POOL = [
          { id: 1, q: "é›»é£¯ç…²ä¸»è¦åˆ©ç”¨é›»æµçš„ä»€éº¼æ•ˆæ‡‰ä¾†ç…®é£¯ï¼Ÿ", options: [{ text: "ç†±æ•ˆæ‡‰", correct: true }, { text: "ç£æ•ˆæ‡‰", correct: false }, { text: "å…‰æ•ˆæ‡‰", correct: false }], reason: "é›»é£¯ç…²å…§çš„ç™¼ç†±ç·šæœƒç”¢ç”Ÿç†±èƒ½ç…®é£Ÿã€‚", hint: "åˆ†æï¼šé›»é£¯ç…²çš„ç›®çš„æ˜¯ã€Œç…®ç†Ÿã€é£Ÿç‰©ï¼Œé€™éœ€è¦é«˜æº«ã€‚" },
          { id: 2, q: "å»¢éµè™•ç†å ´çš„èµ·é‡æ©Ÿåˆ©ç”¨ä»€éº¼ä¾†å¸èµ·å»¢éµï¼Ÿ", options: [{ text: "å·¨å¤§çš„ç£çŸ³", correct: false }, { text: "é›»ç£éµ", correct: true }, { text: "å¸å¡µæ©Ÿ", correct: false }], reason: "é›»ç£éµé€šé›»æœ‰ç£ï¼Œæ–·é›»ç„¡ç£ï¼Œæ–¹ä¾¿æ§åˆ¶ã€‚", hint: "åˆ†æï¼šèµ·é‡æ©Ÿéœ€è¦ã€Œå¸èµ·ã€ä¹Ÿè¦èƒ½éš¨æ™‚ã€Œæ”¾ä¸‹ã€å»¢éµã€‚" },
          { id: 3, q: "ä»¥ä¸‹å“ªç¨®é›»å™¨åŒæ™‚æ‡‰ç”¨äº†ã€Œç†±æ•ˆæ‡‰ã€å’Œã€Œç£æ•ˆæ‡‰ã€ï¼Ÿ", options: [{ text: "LED ç‡ˆ", correct: false }, { text: "é›»æš–çˆ", correct: false }, { text: "é¢¨ç­’ (å¹é¢¨æ©Ÿ)", correct: true }], reason: "é¢¨ç­’æœ‰ç™¼ç†±ç·šç”¢ç”Ÿç†±ï¼Œä¹Ÿæœ‰é¦¬é”ç”¢ç”Ÿé¢¨ã€‚", hint: "åˆ†æï¼šé€™å€‹é›»å™¨æ—¢è¦èƒ½å¹å‡ºé¢¨ï¼ˆé¦¬é”ï¼‰ï¼Œåˆè¦èƒ½å¹å‡ºæš–æ°£ï¼ˆç™¼ç†±ï¼‰ã€‚" },
          { id: 4, q: "å¢åŠ é›»ç£éµç·šåœˆçš„åœˆæ•¸ï¼Œç£åŠ›æœƒæ€æ¨£ï¼Ÿ", options: [{ text: "è®Šå¼·", correct: true }, { text: "è®Šå¼±", correct: false }, { text: "ä¸è®Š", correct: false }], reason: "ç·šåœˆè¶Šå¯†ï¼Œç£å ´è¶Šå¼·ã€‚", hint: "æ•¸æ“šåº«æª¢ç´¢ï¼šé›»ç£éµçš„ç£åŠ›èˆ‡ç·šåœˆå¯†åº¦æˆæ­£æ¯”ã€‚" },
          { id: 5, q: "ç‚ºä»€éº¼æˆ‘å€‘ä¸æ‡‰è©²ç”¨æ¿•æ‰‹è§¸æ‘¸é›»æ£ï¼Ÿ", options: [{ text: "æœƒå¼„é«’é›»æ£", correct: false }, { text: "è‡ªä¾†æ°´æ˜¯é›»å°é«”ï¼Œå®¹æ˜“è§¸é›»", correct: true }, { text: "é–‹é—œæœƒå¤±éˆ", correct: false }], reason: "ä¸€èˆ¬çš„æ°´å«æœ‰é›œè³ªï¼Œæ˜¯å¯ä»¥å°é›»çš„ã€‚", hint: "å®‰å…¨è­¦å‘Šï¼šè‡ªä¾†æ°´ä¸¦éçµ•ç·£é«”ã€‚" },
          { id: 6, q: "ä»¥ä¸‹å“ªç¨®ç‰©æ–™æ˜¯çµ•ç·£é«”ï¼ˆInsulatorï¼‰ï¼Ÿ", options: [{ text: "éŠ…ç·š", correct: false }, { text: "éµé‡˜", correct: false }, { text: "æ©¡è† æ‰‹å¥—", correct: true }], reason: "æ©¡è† ä¸æ˜“è®“é›»æµé€šéï¼Œå¸¸ç”¨ä½œä¿è­·å±¤ã€‚", hint: "åˆ†æï¼šæˆ‘å€‘éœ€è¦æ‰¾å‡ºä¸€ç¨®ã€Œä¸å®¹æ˜“ã€è®“é›»é€šéçš„ææ–™ã€‚" },
          { id: 7, q: "é›»ç†¨æ–—ï¼ˆç‡™æ–—ï¼‰é‹ä½œæ™‚ï¼Œæ˜¯å°‡é›»èƒ½è½‰æ›æˆä»€éº¼ï¼Ÿ", options: [{ text: "è²èƒ½", correct: false }, { text: "ç†±èƒ½", correct: true }, { text: "å‹•èƒ½", correct: false }], reason: "é›»ç†¨æ–—åˆ©ç”¨ç™¼ç†±æ¿ç”¢ç”Ÿé«˜æº«ã€‚", hint: "è§€å¯Ÿï¼šä½¿ç”¨é›»ç†¨æ–—æ™‚ï¼Œåº•æ¿æœƒè®Šå¾—éå¸¸ç‡™ã€‚" },
          { id: 8, q: "é›»ç£éµç›¸å°æ–¼æ°¸ä¹…ç£éµçš„ä¸€å€‹ä¸»è¦å„ªé»æ˜¯ä»€éº¼ï¼Ÿ", options: [{ text: "ç£åŠ›æ°¸é ä¸è®Š", correct: false }, { text: "å¯ä»¥æ§åˆ¶ç£åŠ›çš„é–‹é—œ", correct: true }, { text: "æ¯”è¼ƒè¼•", correct: false }], reason: "é€šé›»æœ‰ç£ï¼Œæ–·é›»ç„¡ç£æ˜¯å…¶æœ€å¤§ç‰¹æ€§ã€‚", hint: "æ¯”è¼ƒï¼šé›»ç£éµå¯ä»¥é€éåˆ‡æ–·é›»æºä¾†æ¶ˆé™¤ç£åŠ›ã€‚" },
          { id: 9, q: "è³¼è²·é›»å™¨æ™‚ï¼Œèƒ½æºæ¨™ç±¤ä¸Šçš„ä¸€ç´šä»£è¡¨ä»€éº¼ï¼Ÿ", options: [{ text: "æœ€æ…³é›»ï¼ˆèƒ½æºæ•ˆç›Šæœ€é«˜ï¼‰", correct: true }, { text: "æœ€è€—é›»", correct: false }, { text: "åƒ¹æ ¼æœ€è²´", correct: false }], reason: "1ç´šæœ€æ…³é›»ï¼Œ5ç´šæœ€è€—é›»ã€‚", hint: "ç’°ä¿æ•¸æ“šï¼šç¶ è‰²çš„ä¸€ç´šæ¨™ç±¤ä»£è¡¨èƒ½æºæ•ˆç›Šæœ€é«˜ã€‚" },
          { id: 10, q: "é›»é¢¨æ‰‡è½‰å‹•æ™‚ï¼Œä¸»è¦å°‡é›»èƒ½è½‰æ›æˆä»€éº¼ï¼Ÿ", options: [{ text: "å…‰èƒ½", correct: false }, { text: "å‹•èƒ½", correct: true }, { text: "åŒ–å­¸èƒ½", correct: false }], reason: "é¦¬é”è½‰å‹•æ‰‡è‘‰ï¼Œç”¢ç”Ÿå‹•èƒ½ã€‚", hint: "ç‰©ç†åˆ†æï¼šæ‰‡è‘‰åœ¨ã€Œç§»å‹•ã€å’Œã€Œæ—‹è½‰ã€ï¼Œé€™å±¬æ–¼æ©Ÿæ¢°é‹å‹•ã€‚" },
          { id: 11, q: "å¦‚æœé›»ç·šçš„çµ•ç·£å¤–å±¤ç ´æäº†ï¼Œæ‡‰è©²æ€éº¼åšï¼Ÿ", options: [{ text: "ç”¨è† ç´™é»å¥½ç¹¼çºŒç”¨", correct: false }, { text: "ç«‹å³åœæ­¢ä½¿ç”¨ä¸¦æ›´æ›", correct: true }, { text: "å°å¿ƒé¿é–‹ç ´æè™•å³å¯", correct: false }], reason: "ç ´æé›»ç·šæ¥µæ˜“å¼•è‡´æ¼é›»æˆ–ç«ç½ã€‚", hint: "å®‰å…¨å”è­°ï¼šç ´æçš„çµ•ç·£å±¤æœƒå°è‡´æ¼é›»é¢¨éšªã€‚" },
          { id: 12, q: "ä»¥ä¸‹å“ªå€‹æ˜¯èƒ½å¤ å°é›»çš„éé‡‘å±¬ï¼Ÿ", options: [{ text: "æœ¨é ­", correct: false }, { text: "çŸ³å¢¨ (é‰›ç­†èŠ¯)", correct: true }, { text: "ç»ç’ƒ", correct: false }], reason: "çŸ³å¢¨æ˜¯å°‘æ•¸èƒ½å°é›»çš„éé‡‘å±¬ã€‚", hint: "ç‰¹ä¾‹åˆ†æï¼šé‰›ç­†èŠ¯çš„ä¸»è¦æˆåˆ†æ˜¯ç¢³ã€‚" },
          { id: 13, q: "é›»éˆ´ (Electric Bell) èƒ½å¤ ç™¼è²ï¼Œæ˜¯å› ç‚ºè£¡é¢æœ‰ä»€éº¼è£ç½®ï¼Ÿ", options: [{ text: "é›»ç£éµ", correct: true }, { text: "ç™¼ç†±ç·š", correct: false }, { text: "LED ç‡ˆ", correct: false }], reason: "é›»ç£éµå¸å¼•å°éšæ•²æ“Šéˆ´è“‹ã€‚", hint: "æ§‹é€ åˆ†æï¼šé›»éˆ´éœ€è¦ä¸€å€‹è£ç½®ä¾†å¿«é€Ÿå¸å¼•å’Œé‡‹æ”¾å°éšå­ã€‚" },
          { id: 14, q: "è¦æƒ³å¢å¼·é›»ç£éµçš„ç£åŠ›ï¼Œé™¤äº†å¢åŠ ç·šåœˆï¼Œé‚„å¯ä»¥ï¼Ÿ", options: [{ text: "æ¸›å°‘é›»æ± æ•¸é‡", correct: false }, { text: "å¢åŠ ä¸²è¯é›»æ± æ•¸é‡", correct: true }, { text: "å°‡éµèŠ¯æ›æˆæœ¨æ£’", correct: false }], reason: "å¢åŠ é›»æ± ï¼ˆä¸²è¯ï¼‰å¯å¢åŠ é›»æµï¼Œå¢å¼·ç£åŠ›ã€‚", hint: "èƒ½é‡å…¬å¼ï¼šç£åŠ›èˆ‡é›»æµå¤§å°æœ‰é—œã€‚" },
          { id: 15, q: "LED ç‡ˆæ¯”å‚³çµ±é¢çµ²ç‡ˆæ³¡å„ªå‹çš„åœ°æ–¹æ˜¯ï¼Ÿ", options: [{ text: "æ›´æ…³é›»ã€å£½å‘½æ›´é•·", correct: true }, { text: "æœƒç”¢ç”Ÿæ›´å¤šç†±èƒ½", correct: false }, { text: "åƒ¹æ ¼ä¸€å®šæœ€ä¾¿å®œ", correct: false }], reason: "LED èƒ½é‡è½‰æ›æ•ˆç‡é«˜ï¼Œè¼ƒå°‘æµªè²»åœ¨ç†±èƒ½ã€‚", hint: "æ¯”è¼ƒï¼šç¾ä»£å®¶åº­å¤šä½¿ç”¨ LED ç‡ˆæ˜¯å› ç‚ºå®ƒæ›´ç’°ä¿ã€‚" },
          { id: 16, q: "é›»æ± ä¸Šé¢æ¨™ç¤ºçš„ '+' è™Ÿä»£è¡¨ä»€éº¼ï¼Ÿ", options: [{ text: "æ­£æ¥µ (Positive)", correct: true }, { text: "è² æ¥µ (Negative)", correct: false }, { text: "ä¸­æ€§", correct: false }], reason: "é›»æ± æœ‰æ­£æ¥µ(+)å’Œè² æ¥µ(-)ã€‚", hint: "åŸºç¤çŸ¥è­˜ï¼š+ ä»£è¡¨æ­£ï¼Œ- ä»£è¡¨è² ã€‚" },
          { id: 17, q: "å¦‚æœæ”¹è®Šé€£æ¥é›»ç£éµçš„é›»æ± æ­£è² æ¥µæ–¹å‘ï¼Œæœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ", options: [{ text: "ç£åŠ›æ¶ˆå¤±", correct: false }, { text: "ç£æ¥µ (N/S) æœƒå€’è½‰", correct: true }, { text: "é›»æ± æœƒçˆ†ç‚¸", correct: false }], reason: "é›»æµæ–¹å‘æ”¹è®Šï¼Œç£å ´æ–¹å‘ä¹Ÿæœƒæ”¹è®Šã€‚", hint: "ç‰©ç†å®šå¾‹ï¼šé›»æµæ–¹å‘æ±ºå®šç£å ´æ–¹å‘ã€‚" },
          { id: 18, q: "ä»€éº¼è£ç½®å¯ä»¥ä¿è­·é›»è·¯ï¼Œåœ¨é›»æµéå¤§æ™‚è‡ªå‹•åˆ‡æ–·é›»æºï¼Ÿ", options: [{ text: "ä¿éšªçµ² (Fuse) / æ–·è·¯å™¨", correct: true }, { text: "é›»ç·š", correct: false }, { text: "æ’åº§", correct: false }], reason: "é˜²æ­¢éè¼‰å¼•èµ·ç«ç½ã€‚", hint: "å®‰å…¨è£ç½®ï¼šå®¶è£¡çš„é›»ç®±è£¡éƒ½æœ‰é€™å€‹æ±è¥¿ã€‚" },
          { id: 19, q: "ç£æµ®åˆ—è»Šåˆ©ç”¨ä»€éº¼åŸç†æ‡¸æµ®åœ¨è·¯è»Œä¸Šï¼Ÿ", options: [{ text: "ç©ºæ°£æµ®åŠ›", correct: false }, { text: "ç£åŠ›åŒæ¥µç›¸æ‹’ / ç•°æ¥µç›¸å¸", correct: true }, { text: "ç†±æ°£çƒåŸç†", correct: false }], reason: "åˆ©ç”¨å¼·å¤§çš„é›»ç£åŠ›æŠµæ¶ˆé‡åŠ›ã€‚", hint: "ç§‘æŠ€æ‡‰ç”¨ï¼šå®ƒå«ã€Œç£ã€æµ®åˆ—è»Šã€‚" },
          { id: 20, q: "ä»¥ä¸‹å“ªé …ä¸æ˜¯ç¯€ç´„ç”¨é›»çš„å¥½ç¿’æ…£ï¼Ÿ", options: [{ text: "é›¢é–‹æˆ¿é–“éš¨æ‰‹é—œç‡ˆ", correct: false }, { text: "æŠŠå†·æ°£æº«åº¦èª¿åˆ°æœ€ä½ (16åº¦)", correct: true }, { text: "é¸ç”¨ä¸€ç´šèƒ½æºæ¨™ç±¤é›»å™¨", correct: false }], reason: "å†·æ°£æº«åº¦é©ä¸­ (25.5åº¦) æ‰ç’°ä¿ã€‚", hint: "å¸¸è­˜åˆ¤æ–·ï¼šå†·æ°£è¶Šå†·ï¼Œå£“ç¸®æ©Ÿé‹ä½œè¶Šä¹…ï¼Œè¶Šè€—é›»ã€‚" },
          // --- æ–°å¢ 10 æ¢é¡Œç›® ---
          { id: 21, q: "ç”šéº¼æ˜¯ã€ŒçŸ­è·¯ã€(Short Circuit)ï¼Ÿ", options: [{ text: "é›»æµä¸ç¶“éé›»å™¨ï¼Œç›´æ¥ç”±é›»æºä¸€æ¥µæµå‘å¦ä¸€æ¥µ", correct: true }, { text: "é›»ç·šå¤ªçŸ­", correct: false }, { text: "å®‰å…¨åœ°åˆ‡æ–·é›»æº", correct: false }], reason: "çŸ­è·¯æœƒå°è‡´é›»æµéå¤§ï¼Œæ¥µæ˜“å¼•èµ·ç«ç½ã€‚", hint: "å±éšªè­¦å‘Šï¼šé›»æµèµ°äº†ã€Œæ·å¾‘ã€ï¼Œæ²’æœ‰ç¶“éä»»ä½•é˜»ç¤™ã€‚" },
          { id: 22, q: "ç‚ºäº†ç¯€çœèƒ½æºï¼Œä½¿ç”¨æ´—è¡£æ©Ÿæ™‚æ‡‰è©²ï¼Ÿ", options: [{ text: "å„²æ»¿ä¸€æ©Ÿè¡£ç‰©æ‰æ´—", correct: true }, { text: "åªæœ‰å…©ä»¶è¡£æœä¹Ÿé–‹æ©Ÿæ´—", correct: false }, { text: "ç”¨ç†±æ°´æ´—è¡£æœ", correct: false }], reason: "æ¸›å°‘é–‹æ©Ÿæ¬¡æ•¸å¯ä»¥ç¯€çœé›»åŠ›å’Œæ°´ã€‚", hint: "ç”Ÿæ´»æ‡‰ç”¨ï¼šå¤šæ´—å¹¾æ¬¡å’Œä¸€æ¬¡æ´—å®Œï¼Œå“ªå€‹æ›´çœé›»ï¼Ÿ" },
          { id: 23, q: "äººé«”æ˜¯å¦å°é›»é«”ï¼Ÿ", options: [{ text: "æ˜¯", correct: true }, { text: "å¦", correct: false }, { text: "åªæœ‰æ‰‹éƒ¨å°é›»", correct: false }], reason: "äººé«”å«æœ‰å¤§é‡æ°´åˆ†å’Œé›¢å­ï¼Œæ˜¯å°é›»é«”ã€‚", hint: "å®‰å…¨çŸ¥è­˜ï¼šé€™å°±æ˜¯ç‚ºä»€éº¼è§¸é›»æœƒå°äººé€ æˆå‚·å®³ã€‚" },
          { id: 24, q: "åœ¨ä¸ä½¿ç”¨é›»å™¨æ™‚ï¼Œç‚ºä»€éº¼å»ºè­°æ‹”æ‰æ’é ­æˆ–é—œæ‰é–‹é—œæ£ï¼Ÿ", options: [{ text: "é˜²æ­¢é›»å™¨è™•æ–¼å‚™ç”¨ç‹€æ…‹æ¶ˆè€—é›»åŠ›", correct: true }, { text: "é˜²æ­¢ç°å¡µé€²å…¥", correct: false }, { text: "æœƒè®“é›»å™¨è®Šå£", correct: false }], reason: "è¨±å¤šé›»å™¨åœ¨å‚™ç”¨æ¨¡å¼(Standby)ä¸‹ä»æœƒæ¶ˆè€—å¾®é‡é›»åŠ›ã€‚", hint: "ç’°ä¿è²¼å£«ï¼šå‚™ç”¨é›»æºä¹Ÿæ˜¯ä¸€ç¨®æµªè²»ã€‚" },
          { id: 25, q: "æšè²å™¨ (Loudspeaker) å°‡é›»èƒ½ä¸»è¦è½‰æ›æˆä»€éº¼ï¼Ÿ", options: [{ text: "å…‰èƒ½", correct: false }, { text: "è²èƒ½", correct: true }, { text: "åŒ–å­¸èƒ½", correct: false }], reason: "é›»æµè¨Šè™Ÿä½¿éœ‡è†œéœ‡å‹•ï¼Œç”¢ç”Ÿè²éŸ³ã€‚", hint: "ç›´è§€åˆ¤æ–·ï¼šæšè²å™¨æ˜¯ç”¨ä¾†åšä»€éº¼çš„ï¼Ÿ" },
          { id: 26, q: "é›»å‹•æ©Ÿ (Motor) çš„ä½œç”¨æ˜¯ä»€éº¼ï¼Ÿ", options: [{ text: "å°‡å‹•èƒ½è½‰ç‚ºé›»èƒ½", correct: false }, { text: "å°‡é›»èƒ½è½‰ç‚ºå‹•èƒ½", correct: true }, { text: "å°‡é›»èƒ½è½‰ç‚ºè²èƒ½", correct: false }], reason: "é¦¬é”åˆ©ç”¨ç£æ•ˆæ‡‰ç”¢ç”Ÿè½‰å‹•ã€‚", hint: "åŠŸèƒ½åˆ†æï¼šé¢¨æ‰‡ã€æ´—è¡£æ©Ÿè£¡é¢éƒ½æœ‰å®ƒï¼Œè®“æ©Ÿå™¨ã€Œå‹•ã€èµ·ä¾†ã€‚" },
          { id: 27, q: "é›»å£“çš„å–®ä½æ˜¯ä»€éº¼ï¼Ÿ", options: [{ text: "ä¼ç‰¹ (Volt)", correct: true }, { text: "å®‰åŸ¹ (Ampere)", correct: false }, { text: "ç“¦ç‰¹ (Watt)", correct: false }], reason: "V ä»£è¡¨ä¼ç‰¹ã€‚", hint: "å–®ä½è­˜åˆ¥ï¼šé›»æ± ä¸Šé€šå¸¸æœƒå¯«è‘— 1.5Vã€‚" },
          { id: 28, q: "ä»¥ä¸‹å“ªç¨®ç™¼é›»æ–¹å¼å±¬æ–¼ã€Œä¸å¯å†ç”Ÿèƒ½æºã€ï¼Ÿ", options: [{ text: "å¤ªé™½èƒ½", correct: false }, { text: "é¢¨åŠ›", correct: false }, { text: "ç‡ƒç…¤ç™¼é›»", correct: true }], reason: "ç…¤ç‚­æ˜¯åŒ–çŸ³ç‡ƒæ–™ï¼Œç”¨å®Œå°±æ²’äº†ã€‚", hint: "è³‡æºåˆ†é¡ï¼šå“ªç¨®è³‡æºæ˜¯æŒ–å‡ºä¾†ç‡’æ‰å°±ç„¡æ³•å†ç”Ÿçš„ï¼Ÿ" },
          { id: 29, q: "åœ¨é›»è·¯åœ–ä¸­ï¼Œç›´ç·šé€šå¸¸ä»£è¡¨ä»€éº¼ï¼Ÿ", options: [{ text: "é›»æ± ", correct: false }, { text: "é›»ç·š", correct: true }, { text: "ç‡ˆæ³¡", correct: false }], reason: "ç›´ç·šä»£è¡¨é€£æ¥å„å…ƒä»¶çš„å°ç·šã€‚", hint: "åœ–å½¢è­˜åˆ¥ï¼šé›»è·¯åœ–ä¸­é€£æ¥å„å€‹éƒ¨åˆ†çš„ç·šæ¢ã€‚" },
          { id: 30, q: "æ‰‹æ¿•æ™‚æ‹”æ’é ­å¯èƒ½æœƒå°è‡´ä»€éº¼å¾Œæœï¼Ÿ", options: [{ text: "æ’é ­è®Šä¹¾", correct: false }, { text: "è§¸é›»", correct: true }, { text: "åœé›»", correct: false }], reason: "æ°´é™ä½äº†çš®è†šçš„é›»é˜»ï¼Œæ¥µæ˜“è§¸é›»ã€‚", hint: "å®‰å…¨è­¦å‘Šï¼šæ°´å’Œé›»æ˜¯å±éšªçš„çµ„åˆã€‚" }
        ];

        // --- å…§å»º AI æç¤ºçµ„ä»¶ ---
        function TAS_Hint({ hintText }) {
          const [show, setShow] = useState(false);
          const [loading, setLoading] = useState(false);

          const handleAnalyze = () => {
            if (show) return;
            setLoading(true);
            setTimeout(() => {
              setLoading(false);
              setShow(true);
            }, 800);
          };

          return (
            <div className="mt-4">
              {!show && !loading && (
                <button 
                  onClick={handleAnalyze}
                  className="flex items-center gap-2 text-xs font-mono text-cyan-400 border border-cyan-500/50 bg-cyan-900/20 px-3 py-2 rounded-lg hover:bg-cyan-900/40 transition-colors mx-auto"
                >
                  <Sparkles size={14} /> T.A.S. æˆ°è¡“åˆ†æ
                </button>
              )}
              
              {loading && (
                <div className="text-xs font-mono text-cyan-400 animate-pulse flex items-center justify-center gap-2">
                  <Activity size={14} className="animate-spin" /> åˆ†æé‹ç®—ä¸­...
                </div>
              )}

              {show && (
                <div className="bg-cyan-950/50 border-l-2 border-cyan-500 p-3 rounded-r-lg text-left animate-in slide-in-from-left-2 fade-in">
                  <div className="flex items-center gap-2 text-cyan-400 font-bold text-xs mb-1">
                    <BrainCircuit size={14} /> åˆ†æçµæœï¼š
                  </div>
                  <p className="text-slate-300 text-sm leading-relaxed">{hintText}</p>
                </div>
              )}
            </div>
          );
        }

        // --- Screens ---

        function StartScreen({ onStart }) {
          const [name, setName] = useState('');
          
          return (
            <div className="text-center space-y-8 animate-fade-in-up">
              <div className="relative inline-block group">
                <div className="absolute inset-0 bg-cyan-500 blur-3xl opacity-20 animate-pulse"></div>
                <div className="w-40 h-40 mx-auto bg-slate-900 rounded-full border-4 border-cyan-500 flex items-center justify-center shadow-[0_0_50px_rgba(6,182,212,0.3)]">
                   <Zap size={80} className="text-cyan-400 group-hover:scale-110 transition-transform duration-500" />
                </div>
              </div>
              
              <div>
                <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 tracking-tight pb-2">
                  é›»ä¹‹ç‰¹å·¥éšŠ
                </h1>
                <h2 className="text-2xl text-cyan-200 mt-2 font-light tracking-widest uppercase">RPG åƒç´ æˆ°è¨˜</h2>
              </div>

              <div className="max-w-md mx-auto bg-slate-900/80 p-8 rounded-2xl border border-cyan-800 shadow-[0_0_50px_rgba(8,145,178,0.1)] backdrop-blur-md">
                <div className="mb-6 flex items-center justify-center gap-2 text-cyan-300 text-sm font-mono bg-cyan-900/30 p-2 rounded-lg border border-cyan-700/50">
                  <BrainCircuit size={16} /> æˆ°è¡“åˆ†æç³»çµ± (T.A.S.) å·²é€£ç·š
                </div>
                <p className="text-slate-400 mb-6 text-lg">è¼¸å…¥ä½ çš„ç‰¹å·¥ä»£è™Ÿï¼Œæº–å‚™è¦ºé†’ä½ çš„èƒ½é‡å±¬æ€§...</p>
                <input 
                  type="text" 
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="è¼¸å…¥ä»£è™Ÿ (ä¾‹å¦‚: å°å¼·)" 
                  className="w-full bg-slate-800 border-2 border-slate-700 focus:border-cyan-500 rounded-lg px-4 py-4 text-center text-2xl text-white outline-none transition-all mb-4 placeholder-slate-600 font-bold"
                  onKeyDown={(e) => e.key === 'Enter' && name && onStart(name)}
                />
                <button 
                  onClick={() => name && onStart(name)}
                  disabled={!name}
                  className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 rounded-lg transition-all shadow-lg transform hover:scale-[1.02] active:scale-[0.98]"
                >
                  é–‹å§‹å†’éšª
                </button>
              </div>
            </div>
          );
        }

        function ClassSelectScreen({ onSelect }) {
          return (
            <div className="animate-fade-in w-full max-w-5xl mx-auto">
              <h2 className="text-4xl font-bold text-center mb-4 text-white">é¸æ“‡ä½ çš„å°ˆå±¬è·æ¥­</h2>
              <p className="text-center text-slate-400 mb-12 text-lg">ä¸åŒçš„è·æ¥­å°æ‡‰ä¸åŒçš„ã€Œé›»çš„æ•ˆæ‡‰ã€ï¼Œæ±ºå®šäº†ä½ çš„æ­¦å™¨å±¬æ€§ã€‚</p>
              
              <div className="grid md:grid-cols-3 gap-8">
                {CLASSES.map((c) => (
                  <button 
                    key={c.id}
                    onClick={() => onSelect(c.id)}
                    className={`group relative rounded-3xl border-2 overflow-hidden transition-all text-left flex flex-col ${c.bg} ${c.borderColor} hover:scale-105 hover:shadow-[0_0_40px_rgba(0,0,0,0.5)]`}
                  >
                    <div className="h-48 bg-slate-900/50 flex items-center justify-center relative overflow-hidden">
                       <div className={`absolute inset-0 opacity-20 bg-${c.activeColor}-500 mix-blend-overlay`}></div>
                       <div className="w-32 h-32 transform group-hover:scale-110 transition-transform duration-500">
                         <c.Avatar />
                       </div>
                    </div>

                    <div className="p-6 flex flex-col flex-grow">
                      <h3 className={`text-3xl font-black ${c.color} mb-2`}>{c.name}</h3>
                      <div className="text-xs font-mono px-2 py-1 bg-black/40 rounded w-fit text-slate-300 mb-3 border border-white/10">å°ˆç²¾: {c.roleType === 'Magnetic' ? 'ç£æ•ˆæ‡‰' : c.roleType === 'Thermal' ? 'ç†±æ•ˆæ‡‰' : 'å…‰æ•ˆæ‡‰'}</div>
                      <p className="text-slate-300 leading-relaxed font-medium mb-4">{c.desc}</p>
                      
                      <div className="mt-auto pt-4 border-t border-white/10 flex justify-between items-center text-sm font-mono text-slate-400">
                        <span>å°ˆå±¬æ­¦å™¨</span>
                        <span className={c.color}>{c.weaponName}</span>
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          );
        }

        // --- Level 1 Logic ---

        function Level1_Main({ playerClass, getQuestions, onReset, onComplete }) {
          const [phase, setPhase] = useState('quiz'); 
          
          if (phase === 'quiz') {
            return (
              <Level1_Quiz 
                getQuestions={getQuestions} 
                onQuizPass={() => setPhase('treasure')} 
                onQuizFail={onReset}
              />
            );
          } else {
            return <Level1_Treasure playerClass={playerClass} onComplete={onComplete} />;
          }
        }

        function Level1_Quiz({ getQuestions, onQuizPass, onQuizFail }) {
          const [qIndex, setQIndex] = useState(0);
          const [showFeedback, setShowFeedback] = useState(false);
          const [isCorrect, setIsCorrect] = useState(false);
          const [score, setScore] = useState(0);
          const [quizQuestions, setQuizQuestions] = useState([]);
          const [isFinished, setIsFinished] = useState(false);

          useEffect(() => {
            setQuizQuestions(getQuestions(4));
          }, [getQuestions]);

          const handleAnswer = (correct) => {
            setIsCorrect(correct);
            setShowFeedback(true);
            if (correct) {
              setScore(prev => prev + 1);
            }
          };

          const nextQ = () => {
            setShowFeedback(false);
            if (qIndex < quizQuestions.length - 1) {
              setQIndex(prev => prev + 1);
            } else {
              setIsFinished(true);
            }
          };

          if (quizQuestions.length === 0) return <div className="text-center text-white mt-20 animate-pulse">æ­£åœ¨è¼‰å…¥å®‰å…¨å”è­°...</div>;

          if (isFinished) {
            const passed = score >= 3;
            return (
              <div className="max-w-xl mx-auto w-full animate-fade-in text-center p-8 bg-slate-900 border-2 border-slate-700 rounded-2xl shadow-2xl">
                <div className="mb-6">
                  {passed ? <CheckCircle size={80} className="mx-auto text-green-500 mb-4 animate-bounce"/> : <Frown size={80} className="mx-auto text-red-500 mb-4 animate-pulse"/>}
                  <h2 className={`text-3xl font-bold mb-2 ${passed ? 'text-green-400' : 'text-red-400'}`}>
                    {passed ? "èªè­‰é€šéï¼" : "èªè­‰å¤±æ•—..."}
                  </h2>
                  <p className="text-slate-300 text-lg">
                    ä½ çš„æˆç¸¾: <span className="font-mono text-2xl font-bold text-white">{score}/4</span>
                  </p>
                  {!passed && <p className="text-slate-400 mt-2 text-sm">éœ€è¦ç­”å° 3 é¡Œæˆ–ä»¥ä¸Šæ‰èƒ½é–‹å•Ÿå¯¶åº«ã€‚</p>}
                </div>

                {passed ? (
                  <button onClick={onQuizPass} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform hover:scale-105">
                    é€²å…¥å¯¶åº« <ArrowRight className="inline ml-2"/>
                  </button>
                ) : (
                  <button onClick={onQuizFail} className="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform hover:scale-105">
                    é‡æ–°ç‰¹è¨“ <RotateCcw className="inline ml-2"/>
                  </button>
                )}
              </div>
            );
          }

          return (
            <div className="max-w-3xl mx-auto w-full animate-fade-in">
              <div className="flex justify-between items-end mb-6">
                <h2 className="text-3xl font-bold text-white flex items-center gap-3">
                  <Terminal size={32} className="text-slate-400" /> 
                  å€åŸŸ 1: å®‰å…¨é–˜é–€èªè­‰
                </h2>
                <span className="font-mono text-slate-400 bg-slate-800 px-3 py-1 rounded-lg">Check {qIndex + 1}/{quizQuestions.length}</span>
              </div>

              <div className="bg-slate-900 border border-slate-700 rounded-2xl p-8 shadow-2xl min-h-[400px] flex flex-col justify-center relative">
                <div className="absolute top-4 right-4 flex items-center gap-2 text-slate-500 font-mono text-sm">
                   <Lock size={16} /> éœ€ç­”å° 3 é¡Œ
                </div>
                
                <h3 className="text-2xl font-bold mb-8 leading-relaxed text-slate-100">
                  {quizQuestions[qIndex].q}
                </h3>

                {!showFeedback ? (
                  <div className="space-y-4">
                    <div className="grid gap-4">
                      {quizQuestions[qIndex].options.map((opt, i) => (
                        <button 
                          key={i}
                          onClick={() => handleAnswer(opt.correct)}
                          className="group p-6 bg-slate-800 hover:bg-slate-700 border-2 border-slate-700 hover:border-blue-400 rounded-xl text-left transition-all hover:translate-x-2 flex items-center justify-between"
                        >
                          <div className="flex items-center gap-4">
                            <span className="font-mono text-slate-500 group-hover:text-blue-400 transition-colors text-lg">0{i+1}</span>
                            <span className="text-lg font-medium text-slate-200 group-hover:text-white">{opt.text}</span>
                          </div>
                        </button>
                      ))}
                    </div>
                    <TAS_Hint hintText={quizQuestions[qIndex].hint} />
                  </div>
                ) : (
                  <div className={`p-6 rounded-xl border-2 text-center animate-in zoom-in-95 ${isCorrect ? 'bg-green-900/30 border-green-500' : 'bg-red-900/30 border-red-500'}`}>
                    <div className="flex justify-center mb-4">
                      {isCorrect ? <CheckCircle size={48} className="text-green-500" /> : <XCircle size={48} className="text-red-500" />}
                    </div>
                    <h4 className={`text-xl font-bold mb-2 ${isCorrect ? 'text-green-400' : 'text-red-400'}`}>
                      {isCorrect ? "å›ç­”æ­£ç¢ºï¼" : "å›ç­”éŒ¯èª¤ï¼"}
                    </h4>
                    <p className="text-slate-300 mb-6">{quizQuestions[qIndex].reason}</p>
                    <button 
                      onClick={nextQ}
                      className="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-lg font-bold transition-all"
                    >
                      {qIndex < quizQuestions.length - 1 ? "ä¸‹ä¸€é¡Œ" : "æŸ¥çœ‹çµæœ"}
                    </button>
                  </div>
                )}
              </div>
            </div>
          );
        }

        function Level1_Treasure({ playerClass, onComplete }) {
          const [selectedTreasure, setSelectedTreasure] = useState(null);
          const [errorMsg, setErrorMsg] = useState('');

          const handleSelect = (treasure) => {
            setSelectedTreasure(treasure);
            setErrorMsg('');
          };

          const confirmSelection = () => {
            if (!selectedTreasure) return;

            if (selectedTreasure.type === playerClass.roleType) {
              onComplete(selectedTreasure.name);
            } else {
              let correctEffect = playerClass.roleType === 'Magnetic' ? 'ç£æ•ˆæ‡‰' : playerClass.roleType === 'Thermal' ? 'ç†±æ•ˆæ‡‰' : 'å…‰æ•ˆæ‡‰';
              setErrorMsg(`è­¦å‘Šï¼šä½ çš„è·æ¥­æ˜¯ã€${playerClass.name}ã€‘ï¼Œåªèƒ½è£å‚™ã€${correctEffect}ã€‘çš„å¯¶ç‰©ï¼`);
            }
          };

          return (
            <div className="max-w-5xl mx-auto w-full animate-fade-in text-center">
              <div className="mb-8">
                <Unlock size={48} className="mx-auto text-yellow-400 mb-4 animate-bounce" />
                <h2 className="text-4xl font-bold text-white mb-2">å¯¶åº«å·²é–‹å•Ÿï¼</h2>
                <p className="text-slate-300 text-lg">
                  è«‹æ ¹æ“šä½ çš„è·æ¥­ <span className={`${playerClass.color} font-bold`}>{playerClass.name}</span>ï¼Œ<br/>
                  é¸æ“‡ä¸€ä»¶é©åˆä½ çš„æ ¸å¿ƒå¯¶ç‰©å¸¶å¾€ä¸‹ä¸€é—œã€‚
                </p>
              </div>

              <div className="grid md:grid-cols-3 gap-6 mb-8">
                {TREASURES.map((t, i) => (
                  <button
                    key={i}
                    onClick={() => handleSelect(t)}
                    className={`relative p-8 rounded-2xl border-2 transition-all flex flex-col items-center gap-4 group ${
                      selectedTreasure === t 
                        ? `bg-slate-800 border-white shadow-[0_0_30px_rgba(255,255,255,0.2)] scale-105` 
                        : 'bg-slate-900/50 border-slate-700 hover:border-slate-500 hover:bg-slate-800'
                    }`}
                  >
                    <div className={`w-24 h-24 p-4 rounded-full bg-slate-950 shadow-inner group-hover:scale-110 transition-transform duration-300`}>
                      {t.icon}
                    </div>
                    <h3 className="text-xl font-bold text-slate-200">{t.name}</h3>
                    <p className="text-slate-400 text-sm">{t.desc}</p>
                    {selectedTreasure === t && (
                      <div className="absolute top-4 right-4 text-green-400">
                        <CheckCircle size={24} />
                      </div>
                    )}
                  </button>
                ))}
              </div>

              {errorMsg && (
                <div className="bg-red-900/50 border border-red-500 text-red-200 px-6 py-4 rounded-xl mb-6 inline-block animate-shake">
                  <div className="flex items-center gap-2">
                    <AlertTriangle size={20} />
                    {errorMsg}
                  </div>
                </div>
              )}

              <button
                onClick={confirmSelection}
                disabled={!selectedTreasure}
                className={`px-12 py-4 rounded-full font-black text-xl shadow-lg transition-all transform hover:scale-105 active:scale-95 flex items-center gap-2 mx-auto ${
                  !selectedTreasure 
                    ? 'bg-slate-700 text-slate-500 cursor-not-allowed' 
                    : `${playerClass.btnBg} text-white`
                }`}
              >
                ç¢ºèªé ˜å– <ArrowRight size={24} />
              </button>
            </div>
          );
        }

        // --- Level 2 Logic ---

        function Level2_Upgrade_Challenge({ playerClass, getQuestions, inventory, onComplete }) {
          const [stage, setStage] = useState(0); 
          const [power, setPower] = useState(0);
          const [perfectCount, setPerfectCount] = useState(0); 
          const [modalOpen, setModalOpen] = useState(false);
          const [currentQ, setCurrentQ] = useState(null);
          const [feedback, setFeedback] = useState(null);

          const upgradeSteps = [
            { name: "å®‰è£æ ¸å¿ƒé›»æº", gain: 50 },
            { name: "å¼·åŒ–èƒ½é‡å‚³è¼¸", gain: 70 },
            { name: "å„ªåŒ–è¼¸å‡ºåŠŸç‡", gain: 100 }
          ];

          const startUpgrade = () => {
            const q = getQuestions(1)[0];
            setCurrentQ(q);
            setModalOpen(true);
            setFeedback(null);
          };

          const handleAnswer = (correct) => {
            const stepGain = upgradeSteps[stage].gain;
            const actualGain = correct ? stepGain : 0; 
            
            if (correct) {
              setPerfectCount(prev => prev + 1);
            }

            setFeedback({
              correct,
              msg: correct ? "å‡ç´šæˆåŠŸï¼å®Œç¾å®‰è£ï¼" : "å®‰è£å¤±æ•—...çµ„ä»¶æå£ï¼Œç„¡æ³•ç²å¾—èƒ½é‡ã€‚",
              gain: actualGain
            });

            setTimeout(() => {
              setPower(prev => prev + actualGain);
              setModalOpen(false);
              if (stage < 2) {
                setStage(prev => prev + 1);
              } else {
                setStage(3); 
              }
            }, 2500);
          };

          return (
            <div className="max-w-4xl mx-auto w-full animate-fade-in">
              <div className="mb-8 text-center">
                <h2 className="text-3xl font-bold text-white mb-2">å€åŸŸ 2: æ­¦å™¨ç ”ç™¼å®¤</h2>
                <p className="text-slate-400 text-lg">
                  æ­£åœ¨ä½¿ç”¨ <span className="text-white font-mono bg-slate-800 px-2 rounded">{inventory[0]}</span> å¼·åŒ–æ­¦å™¨ã€‚<br/>
                  è§£æ±º<span className="text-yellow-400">æŠ€è¡“é›£é¡Œ</span>ä»¥æ±ºå®šæœ€çµ‚æˆ°é¬¥åŠ›ã€‚<br/>
                  <span className="text-red-400 text-sm">æ³¨æ„ï¼šç­”éŒ¯å•é¡Œå°‡å°è‡´è©²éšæ®µå‡ç´šå¤±æ•— (0 åŠ æˆ)ã€‚</span>
                </p>
              </div>

              <div className="flex flex-col md:flex-row gap-8 items-center justify-center">
                
                {/* Weapon Visual - Blueprint Card */}
                <div className="relative w-80 h-96 bg-slate-900 rounded-3xl border-4 border-slate-700 overflow-hidden shadow-2xl group">
                   {/* Grid Background */}
                   <div className="absolute inset-0 bg-[linear-gradient(to_right,#1e293b_1px,transparent_1px),linear-gradient(to_bottom,#1e293b_1px,transparent_1px)] bg-[size:20px_20px] opacity-20"></div>
                   
                   <div className="p-6 h-full flex flex-col">
                     <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                       <span className="text-xs font-mono text-slate-500">BLUEPRINT: {playerClass.weaponName}</span>
                       <span className="text-xs font-mono text-yellow-500">MK-{stage+1}</span>
                     </div>
                     
                     <div className="flex-grow flex items-center justify-center relative">
                       <div className={`absolute inset-0 rounded-full blur-3xl opacity-20 ${playerClass.bg}`}></div>
                       <div className={`w-40 h-40 transition-all duration-700 transform ${stage > 0 ? 'scale-110' : 'scale-100'} ${stage > 1 ? 'drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]' : ''}`}>
                          <playerClass.Weapon level={stage+1} />
                       </div>
                     </div>

                     <div className="mt-auto">
                       <div className="flex justify-between text-sm mb-1 text-slate-400">
                         <span>Energy Output</span>
                         <span className="text-white font-mono">{power} MW</span>
                       </div>
                       <div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
                         <div className={`h-full ${playerClass.bg.replace('/80','')} transition-all duration-1000`} style={{width: `${(power/220)*100}%`}}></div>
                       </div>
                     </div>
                   </div>
                </div>

                {/* Upgrade Steps */}
                <div className="flex-1 space-y-4 w-full max-w-md">
                  {stage < 3 ? (
                     <div className="bg-slate-800 p-6 rounded-2xl border border-slate-600">
                       <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                         <BrainCircuit className="text-cyan-400"/> å‡ç´šéšæ®µ {stage + 1}/3
                       </h3>
                       <p className="text-slate-300 mb-6">{upgradeSteps[stage].name}</p>
                       <button 
                         onClick={startUpgrade}
                         className={`w-full py-4 rounded-xl font-bold text-lg text-white shadow-lg transition-transform hover:scale-105 active:scale-95 ${playerClass.btnBg}`}
                       >
                         é–‹å§‹å‡ç´šç¨‹åº
                       </button>
                     </div>
                  ) : (
                    <div className="bg-green-900/40 p-6 rounded-2xl border border-green-500 text-center animate-bounce-in">
                       <h3 className="text-2xl font-bold text-green-400 mb-2">ç ”ç™¼å®Œæˆï¼</h3>
                       <p className="text-slate-300 mb-6">æœ€çµ‚æˆ°é¬¥åŠ›: {power} (å½±éŸ¿BOSSæˆ°å‚·å®³)</p>
                       <button 
                         onClick={() => onComplete({ strength: power, level: 3, perfectCount: perfectCount })} 
                         className="w-full py-4 rounded-xl font-bold text-lg bg-white text-slate-900 hover:bg-slate-200 shadow-lg"
                       >
                         å‰å¾€æˆ°å ´
                       </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Challenge Modal */}
              {modalOpen && currentQ && (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                  <div className="bg-slate-900 border-2 border-slate-600 rounded-2xl p-8 max-w-2xl w-full shadow-2xl animate-zoom-in">
                     {!feedback ? (
                       <>
                         <h3 className="text-yellow-400 font-mono font-bold mb-6 flex items-center gap-2">
                           <AlertTriangle size={20}/> æŠ€è¡“æª¢æ¸¬ä¸­...
                         </h3>
                         <p className="text-xl font-bold text-white mb-8">{currentQ.q}</p>
                         <div className="grid grid-cols-1 gap-4">
                           {currentQ.options.map((opt, i) => (
                             <button 
                               key={i} 
                               onClick={() => handleAnswer(opt.correct)}
                               className="p-4 bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-white rounded-xl text-left font-bold text-slate-200 transition-colors"
                             >
                               {opt.text}
                             </button>
                           ))}
                         </div>
                         <TAS_Hint hintText={currentQ.hint} />
                       </>
                     ) : (
                       <div className="text-center py-8">
                         {feedback.correct ? <CheckCircle size={60} className="mx-auto text-green-500 mb-4"/> : <XCircle size={60} className="mx-auto text-red-500 mb-4"/>}
                         <h3 className={`text-2xl font-bold mb-2 ${feedback.correct ? 'text-green-400' : 'text-red-400'}`}>{feedback.msg}</h3>
                         <p className="text-slate-400 font-mono text-xl">+ {feedback.gain} PWR</p>
                         <div className="mt-4 text-sm text-slate-500">{currentQ.reason}</div>
                       </div>
                     )}
                  </div>
                </div>
              )}
            </div>
          );
        }

        // --- Level 3: Boss Battle ---

        function BossIntro({ playerClass, weaponStats, onStartBattle }) {
          return (
            <div className="text-center animate-pulse-slow max-w-lg mx-auto mt-16 p-8 relative">
              <div className="absolute inset-0 bg-red-500/10 blur-3xl rounded-full"></div>
              <div className="w-40 h-40 mx-auto mb-6 relative">
                 <div className="absolute inset-0 bg-red-600 blur-xl rounded-full opacity-50"></div>
                 <div className="w-full h-full rounded-full border-4 border-red-500 relative z-10 bg-slate-900 overflow-hidden">
                   <AvatarBoss />
                 </div>
              </div>
              
              <h2 className="text-5xl font-black text-red-500 mb-4 tracking-tighter relative z-10">BOSS WARNING</h2>
              <p className="text-2xl text-slate-200 mb-8 font-bold relative z-10">
                <span className="text-red-400">çŸ­è·¯åšå£«</span> æ­£åœ¨å¸æ”¶å…¨åŸé›»åŠ›ï¼
              </p>
              <div className="bg-slate-900/90 p-8 rounded-2xl border border-red-900/50 mb-10 backdrop-blur-md relative z-10 shadow-2xl">
                <div className="flex items-center gap-4 mb-4 pb-4 border-b border-white/10">
                  <div className="w-16 h-16 rounded-lg border-2 border-slate-600 bg-slate-800 overflow-hidden">
                    <playerClass.Avatar />
                  </div>
                  <div className="text-left">
                    <div className="text-xs text-slate-400">å·²è£å‚™æ­¦å™¨</div>
                    <div className={`text-xl font-bold ${playerClass.color}`}>{playerClass.weaponName}</div>
                  </div>
                  <div className="ml-auto font-mono text-yellow-500 font-bold text-xl">PWR: {weaponStats.strength}</div>
                </div>
                <div className="flex items-center gap-3 bg-blue-900/30 p-4 rounded-xl border border-blue-500/50 mb-4 text-left">
                   <Shield size={32} className="text-blue-400 flex-shrink-0" />
                   <div>
                     <div className="font-bold text-blue-300">æˆ°è¡“é˜²ç¦¦ç³»çµ±</div>
                     <div className="text-sm text-slate-400">ä½ æ“æœ‰ä¸€æ¬¡æ€§ã€Œæ‰‹å‹•é˜²ç¦¦ç½©ã€ã€‚æˆ°é¬¥ä¸­è«‹é»æ“Šå³ä¸Šè§’æŒ‰éˆ•ï¼Œåœ¨é—œéµæ™‚åˆ»æŠµæ“‹ Boss çš„æ”»æ“Šã€‚</div>
                   </div>
                </div>
                <div className="flex items-center gap-3 bg-cyan-900/30 p-4 rounded-xl border border-cyan-500/50 mb-4 text-left">
                   <ZapOff size={32} className="text-cyan-400 flex-shrink-0" />
                   <div>
                     <div className="font-bold text-cyan-300">é›»ç£è„ˆè¡ (EMP)</div>
                     <div className="text-sm text-slate-400">å¯ç™¼å°„ EMP ç™±ç˜“ Boss ä¸€å›åˆï¼Œä½¿å…¶ç„¡æ³•æ”»æ“Šã€‚æ¯å ´é™ç”¨ä¸€æ¬¡ã€‚</div>
                   </div>
                </div>
                <p className="text-slate-300 text-sm">
                  <span className="text-yellow-400">æ©Ÿç‡æç¤ºï¼š</span>é›™æ–¹éƒ½æœ‰ <span className="text-yellow-400">10%</span> æ©Ÿç‡è‡ªå‹•è¿´é¿æ”»æ“Šã€‚
                </p>
              </div>
              <button 
                onClick={onStartBattle} 
                className="relative z-10 bg-red-600 hover:bg-red-500 text-white font-black py-4 px-16 rounded-full text-2xl shadow-[0_0_40px_rgba(220,38,38,0.6)] transition-all hover:scale-110 hover:-translate-y-1"
              >
                FIGHT
              </button>
            </div>
          );
        }

        function BossBattle({ player, playerClass, weaponStats, getQuestions, onWin, onLose }) {
          const [currentBoss, setCurrentBoss] = useState('normal'); // 'normal' | 'hidden'
          const [bossHp, setBossHp] = useState(500); 
          const [playerHp, setPlayerHp] = useState(player.maxHp);
          const [combatLog, setCombatLog] = useState(['æˆ°é¬¥é–‹å§‹ï¼çŸ­è·¯åšå£« é‡‹æ”¾äº†é«˜å£“é›»å ´...']);
          const [questionPhase, setQuestionPhase] = useState(true);
          const [currentQ, setCurrentQ] = useState(null);
          
          // Tactical Skills
          const [shield, setShield] = useState(1);
          const [shieldPrimed, setShieldPrimed] = useState(false);
          const [emp, setEmp] = useState(1);
          const [empActive, setEmpActive] = useState(false); // If active, Boss skips next turn
          
          const [bossAttackCount, setBossAttackCount] = useState(0);
          
          // Ultimate Skill State
          const [ultimateUsed, setUltimateUsed] = useState(false);
          
          // Visual Effects State
          const [shake, setShake] = useState(false); 
          const [flash, setFlash] = useState(false); 
          const [floatingText, setFloatingText] = useState(null); 

          useEffect(() => {
            if (questionPhase) {
              const qs = getQuestions(1);
              if (qs.length > 0) {
                setCurrentQ(qs[0]);
              } else {
                setCurrentQ({ q: "èƒ½é‡è€—ç›¡...æœ€å¾Œä¸€æ“Šï¼é›»çš„å–®ä½æ˜¯ï¼Ÿ", options: [{text:"Ampere", correct:true}, {text:"Liter", correct:false}, {text:"Kg", correct:false}], reason:"...", hint: "æç¤ºï¼šé›»æµçš„å–®ä½ä»¥ A é–‹é ­ã€‚" });
              }
            }
          }, [questionPhase, getQuestions]);

          const activateShield = () => {
            if (shield > 0) {
              setShield(0);
              setShieldPrimed(true);
              setCombatLog(prev => [`[ç³»çµ±]: é˜²ç¦¦ç½©å·²å•Ÿå‹•ï¼æº–å‚™æŠµæ“‹ä¸‹ä¸€æ¬¡æ”»æ“Šï¼`, ...prev]);
            }
          };

          const useEmp = () => {
            if (emp > 0) {
              setEmp(0);
              setEmpActive(true);
              setCombatLog(prev => [`[ç³»çµ±]: ç™¼å°„é›»ç£è„ˆè¡ (EMP)ï¼Boss ç³»çµ±ç™±ç˜“ï¼Œä¸‹å›åˆç„¡æ³•æ”»æ“Šï¼`, ...prev]);
              showFloatingText("EMP!", "text-cyan-400 font-black");
              // Immediately go to next question since boss is stunned
              // But we need to wait a bit for effect
              setTimeout(() => {
                 setQuestionPhase(true); 
              }, 1500);
            }
          };

          const useUltimate = () => {
            if (ultimateUsed) return;
            setUltimateUsed(true);
            setQuestionPhase(false); // Skip quiz phase for this turn

            const dmg = 100;
            triggerDamageEffect();
            showFloatingText("ULTIMATE!", "text-purple-400 font-black text-5xl");
            setTimeout(() => showFloatingText(`-${dmg}`, "text-yellow-400 text-4xl"), 800);

            setCombatLog(prev => [`[ä½ ]: ç™¼å‹•å¿…æ®ºæŠ€ã€${playerClass.ultimateName}ã€‘ï¼é€ æˆ ${dmg} é»çœŸå¯¦å‚·å®³ï¼`, ...prev]);
            
            setBossHp(h => {
                const newHp = h - dmg;
                if (newHp <= 0) handleBossDefeat(newHp);
                return Math.max(0, newHp);
            });

            if (bossHp - dmg > 0) {
                setTimeout(() => {
                    setQuestionPhase(true); 
                    setCombatLog(prev => [`[ç³»çµ±]: Boss å—åˆ°å¿…æ®ºæŠ€é‡å‰µï¼Œæš«æ™‚ç„¡æ³•è¡Œå‹•ï¼`, ...prev]);
                }, 2500);
            }
          };

          const showFloatingText = (text, color) => {
            setFloatingText({ text, color, id: Date.now() });
            setTimeout(() => setFloatingText(null), 1000);
          };

          const triggerDamageEffect = () => {
            setShake(true);
            setFlash(true);
            setTimeout(() => { setShake(false); setFlash(false); }, 300);
          };

          const handleBossDefeat = (hp) => {
              if (hp <= 0) {
                  if (currentBoss === 'normal' && weaponStats.perfectCount === 3) {
                      // Transition to Hidden Boss
                      setTimeout(() => {
                          setCurrentBoss('hidden');
                          setBossHp(1000);
                          setBossAttackCount(0);
                          setShield(1); // Reset Skills for part 2
                          setEmp(1);
                          setUltimateUsed(false); // Allow Ultimate only in part 2 if not used? Or reset it? 
                          // Resetting ultimate for Part 2 is fair as it's a new boss
                          
                          setCombatLog(prev => [`âš ï¸ è­¦å‘Šï¼šåµæ¸¬åˆ°æ›´å¼·å¤§çš„èƒ½é‡åæ‡‰ï¼`, `[è¶…è¼‰å¤§å¸]: å‡¡äºº... ç«Ÿæ•¢æŒ‘æˆ°æˆ‘ï¼`, ...prev]);
                          showFloatingText("WARNING!", "text-red-600 font-black text-5xl");
                          setQuestionPhase(true); 
                      }, 1500);
                  } else {
                      setTimeout(onWin, 1500);
                  }
              }
          };

          const bossTurn = () => {
                if (bossHp <= 0) return;

                // 0. Check EMP Stun
                if (empActive) {
                   setCombatLog(prev => [`[ç³»çµ±]: Boss è™•æ–¼ EMP ç™±ç˜“ç‹€æ…‹ï¼Œç„¡æ³•æ”»æ“Šï¼`, ...prev]);
                   showFloatingText("STUNNED", "text-cyan-400");
                   setEmpActive(false); // Consumed
                   setTimeout(() => setQuestionPhase(true), 2000);
                   return;
                }

                // 1. Check Shield
                if (shieldPrimed) {
                   setCombatLog(prev => [`[ç³»çµ±]: é˜²ç¦¦ç½©ç™¼æ®ä½œç”¨ï¼å®Œå…¨æŠµæ“‹äº† Boss çš„é«˜å£“é›»æ“Šï¼`, ...prev]);
                   setShieldPrimed(false); 
                   showFloatingText("BLOCKED", "text-blue-400");
                   setTimeout(() => setQuestionPhase(true), 2000);
                   return;
                }

                // 2. Check Player Evasion (10%)
                const playerEvade = Math.random() < 0.1;

                if (playerEvade) {
                   showFloatingText("è¿´é¿!", "text-green-400");
                   setCombatLog(prev => [`[ä½ ]: æ¥µé™åæ‡‰ï¼æˆåŠŸè¿´é¿äº† Boss çš„æ”»æ“Šï¼`, ...prev]);
                   setTimeout(() => setQuestionPhase(true), 2000);
                } else {
                   // 3. Take Damage
                   let bossDmg = 35;
                   let attackMsg = "å˜—å˜—é€™å€‹é«˜å£“é›»æ“Šï¼";

                   if (currentBoss === 'hidden') {
                     const nextAttackCount = bossAttackCount + 1;
                     setBossAttackCount(nextAttackCount);
                     
                     if (nextAttackCount % 4 === 0) {
                       bossDmg = 50;
                       attackMsg = "çµ•ç·£å´©å£ï¼è™›ç©ºé›·æ“Šï¼";
                       showFloatingText("ULTIMATE!", "text-purple-500 font-black");
                     }
                   }

                   triggerDamageEffect();
                   showFloatingText(`-${bossDmg}`, "text-red-500");
                   setCombatLog(prev => [`[${currentBoss === 'hidden' ? 'è¶…è¼‰å¤§å¸' : 'çŸ­è·¯åšå£«'}]: ${attackMsg} (-${bossDmg})`, ...prev]);
                   setPlayerHp(h => {
                     const newHp = h - bossDmg;
                     if (newHp <= 0) setTimeout(onLose, 1500);
                     return Math.max(0, newHp);
                   });
                   
                   if (playerHp > 0) {
                     setTimeout(() => setQuestionPhase(true), 2000);
                   }
                }
          };

          const handleAttack = (correct) => {
            setQuestionPhase(false);
            
            if (correct) {
              const bossEvade = Math.random() < 0.1;

              if (bossEvade) {
                showFloatingText("MISS", "text-slate-400");
                setCombatLog(prev => [`[Boss]: é«˜é€Ÿé–ƒé¿ï¼ä½ çš„æ”»æ“Šè½ç©ºäº†ï¼`, ...prev]);
              } else {
                const baseDmg = weaponStats.strength > 200 ? 40 : 20; 
                const dmg = Math.floor(weaponStats.strength * 0.9) + baseDmg + Math.floor(Math.random() * 20);
                
                let attackDesc = "";
                if (playerClass.id === 'engineer') attackDesc = `ç™¼å°„ç£åŠ›ç ²ï¼`;
                if (playerClass.id === 'mage') attackDesc = `é‡‹æ”¾é›¢å­æµï¼`;
                if (playerClass.id === 'warrior') attackDesc = `æ®å‹•é›·å°„åŠï¼`;

                triggerDamageEffect();
                showFloatingText(`-${dmg}`, "text-yellow-400");
                setCombatLog(prev => [`[ä½ ]: ${attackDesc} (-${dmg})`, ...prev]);
                setBossHp(h => {
                  const newHp = h - dmg;
                  if (newHp <= 0) handleBossDefeat(newHp);
                  return Math.max(0, newHp);
                });
              }
            } else {
              setCombatLog(prev => [`[ç³»çµ±]: çŸ¥è­˜é€£çµå¤±æ•—... æ”»æ“Šç„¡æ•ˆï¼`, ...prev]);
            }

            if (bossHp > 0) { // Simple check, exact handling in bossTurn
              setTimeout(bossTurn, 1500);
            }
          };

          const getBattleAdvice = () => {
            if (playerHp < 70 && shield > 0 && !shieldPrimed) return "è­¦å ±ï¼šç”Ÿå‘½å€¼å±æ€¥ï¼å»ºè­°ç«‹å³å•Ÿå‹•é˜²ç¦¦ç½©ï¼";
            if (emp > 0 && currentBoss === 'hidden' && (bossAttackCount + 1) % 4 === 0) return "å±éšªï¼šBoss å³å°‡ç™¼å‹•å¤§çµ•ï¼å»ºè­°ä½¿ç”¨ EMP å¹²æ“¾ï¼";
            if (shieldPrimed) return "ç‹€æ…‹ï¼šé˜²ç¦¦ç½©é‹ä½œä¸­ã€‚è«‹å°ˆæ³¨æ”»æ“Šã€‚";
            if (empActive) return "ç‹€æ…‹ï¼šBoss å·²ç™±ç˜“ã€‚å…¨åŠ›è¼¸å‡ºï¼";
            return "å»ºè­°ï¼šè§€å¯Ÿ Boss æ”»æ“Šé »ç‡ï¼Œä¿ç•™æŠ€èƒ½ä»¥å‚™ä¸æ™‚ä¹‹éœ€ã€‚";
          };

          return (
            <div className={`max-w-5xl mx-auto w-full animate-fade-in p-4 ${shake ? 'animate-shake' : ''}`}>
              {/* Damage Flash Overlay */}
              {flash && <div className="absolute inset-0 bg-red-500/20 z-50 pointer-events-none animate-ping"></div>}

              <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-8 relative">
                {/* Player */}
                <div className="text-center relative z-10 order-2 md:order-1 group">
                  <div className="relative inline-block">
                     <div className={`w-32 h-32 rounded-full border-4 ${playerClass.borderColor} flex items-center justify-center mb-4 mx-auto shadow-lg transform hover:scale-105 transition-transform overflow-hidden bg-slate-900`}>
                       <playerClass.Avatar />
                     </div>
                     {shieldPrimed && (
                       <div className="absolute -inset-2 border-4 border-blue-400 rounded-full animate-pulse opacity-50"></div>
                     )}
                     {shieldPrimed && (
                        <div className="absolute -top-2 -right-2 bg-blue-500 rounded-full p-2 shadow-lg z-20">
                          <Shield size={20} className="text-white fill-blue-500" />
                        </div>
                     )}
                     {/* Floating Text Player */}
                     {floatingText && floatingText.color.includes('green') && (
                       <div className={`absolute top-0 left-1/2 -translate-x-1/2 -translate-y-10 text-3xl font-black ${floatingText.color} animate-bounce z-50 drop-shadow-lg`}>
                         {floatingText.text}
                       </div>
                     )}
                     {floatingText && floatingText.color.includes('red') && (
                       <div className={`absolute top-0 left-1/2 -translate-x-1/2 -translate-y-10 text-4xl font-black ${floatingText.color} animate-ping z-50 drop-shadow-lg`}>
                         {floatingText.text}
                       </div>
                     )}
                     {floatingText && floatingText.color.includes('blue') && (
                       <div className={`absolute top-0 left-1/2 -translate-x-1/2 -translate-y-10 text-2xl font-black ${floatingText.color} animate-pulse z-50 drop-shadow-lg`}>
                         {floatingText.text}
                       </div>
                     )}
                  </div>
                  <div className="bg-slate-800 rounded-full h-6 w-40 mx-auto overflow-hidden border border-slate-600 relative">
                     <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold z-10 text-white">{playerHp}/{player.maxHp}</div>
                    <div className={`h-full transition-all duration-500 ${playerHp < 50 ? 'bg-red-500 animate-pulse' : 'bg-green-500'}`} style={{width: `${(playerHp/player.maxHp)*100}%`}}></div>
                  </div>
                  <p className={`font-bold mt-2 text-xl ${playerClass.color}`}>{player.name}</p>
                </div>

                <div className="order-1 md:order-2 text-7xl font-black text-slate-800 italic opacity-50 select-none animate-pulse">VS</div>

                {/* Boss */}
                <div className="text-center relative z-10 order-3">
                  <div className={`w-32 h-32 rounded-full border-4 ${currentBoss === 'hidden' ? 'border-purple-500 shadow-[0_0_30px_rgba(168,85,247,0.5)]' : 'border-red-500'} flex items-center justify-center mb-4 mx-auto shadow-lg animate-bounce-slow overflow-hidden bg-slate-900`}>
                    {currentBoss === 'hidden' ? <AvatarUltimateBoss /> : <AvatarBoss />}
                  </div>
                  {/* Floating Text Boss */}
                  {floatingText && floatingText.color.includes('yellow') && (
                       <div className={`absolute top-0 left-1/2 -translate-x-1/2 -translate-y-10 text-4xl font-black ${floatingText.color} animate-ping z-50 drop-shadow-lg`}>
                         {floatingText.text}
                       </div>
                  )}
                  {floatingText && floatingText.color.includes('purple') && (
                       <div className={`absolute top-0 left-1/2 -translate-x-1/2 -translate-y-10 text-4xl font-black ${floatingText.color} animate-ping z-50 drop-shadow-lg`}>
                         {floatingText.text}
                       </div>
                  )}
                  {floatingText && floatingText.color.includes('slate') && (
                       <div className={`absolute top-0 left-1/2 -translate-x-1/2 -translate-y-10 text-3xl font-black ${floatingText.color} animate-bounce z-50 drop-shadow-lg`}>
                         {floatingText.text}
                       </div>
                  )}
                  {floatingText && floatingText.color.includes('cyan') && (
                       <div className={`absolute top-0 left-1/2 -translate-x-1/2 -translate-y-10 text-3xl font-black ${floatingText.color} animate-shake z-50 drop-shadow-lg`}>
                         {floatingText.text}
                       </div>
                  )}

                  <div className="bg-slate-800 rounded-full h-6 w-40 mx-auto overflow-hidden border border-slate-600 relative">
                     <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold z-10 text-white">{bossHp}</div>
                    <div className={`h-full transition-all duration-500 ${currentBoss === 'hidden' ? 'bg-purple-600' : 'bg-red-600'}`} style={{width: `${(bossHp/(currentBoss === 'hidden' ? 1000 : 500))*100}%`}}></div>
                  </div>
                  <p className={`font-bold mt-2 text-xl ${currentBoss === 'hidden' ? 'text-purple-400' : 'text-red-400'}`}>
                    {currentBoss === 'hidden' ? 'è¶…è¼‰å¤§å¸' : 'çŸ­è·¯åšå£«'}
                  </p>
                </div>
              </div>

              <div className="bg-slate-900 border-t-4 border-slate-700 rounded-2xl shadow-2xl min-h-[300px] flex flex-col relative overflow-hidden">
                <div className={`absolute top-0 left-0 w-full h-1 ${playerClass.bg.replace('/80', '')}`}></div>

                {questionPhase && currentQ ? (
                  <div className="flex-grow flex flex-col items-center justify-center p-8 space-y-8 animate-in slide-in-from-bottom-10 fade-in duration-300 relative w-full">
                    
                    {/* Manual Skills Buttons */}
                    <div className="absolute top-4 right-4 flex gap-2">
                        {emp > 0 && !empActive && (
                            <button 
                              onClick={useEmp}
                              className="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg animate-bounce border border-cyan-400 transition-all hover:scale-105"
                              title="ç™±ç˜“ Boss ä¸€å›åˆ"
                            >
                              <ZapOff size={20} /> EMP (1/1)
                            </button>
                        )}
                        {shield > 0 && !shieldPrimed && (
                            <button 
                              onClick={activateShield}
                              className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg animate-bounce border border-blue-400 transition-all hover:scale-105"
                              title="æŠµæ“‹ä¸€æ¬¡å‚·å®³"
                            >
                              <Shield size={20} /> é˜²ç¦¦ (1/1)
                            </button>
                        )}
                    </div>

                    {/* Status Indicators */}
                    <div className="absolute top-4 right-4 flex gap-2 pointer-events-none">
                        {empActive && (
                             <div className="bg-cyan-900/80 border border-cyan-400 text-cyan-200 px-4 py-2 rounded-lg flex items-center gap-2 backdrop-blur-sm">
                                <ZapOff size={20} /> Boss ç™±ç˜“ä¸­
                            </div>
                        )}
                        {shieldPrimed && (
                             <div className="bg-blue-900/80 border border-blue-400 text-blue-200 px-4 py-2 rounded-lg flex items-center gap-2 backdrop-blur-sm">
                                <Shield size={20} /> é˜²ç¦¦ç½©å¾…å‘½
                            </div>
                        )}
                    </div>

                    {/* Ultimate Skill Button - Only for Hidden Boss */}
                    {currentBoss === 'hidden' && !ultimateUsed && (
                        <button 
                          onClick={useUltimate}
                          className="absolute top-4 left-4 bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white px-6 py-3 rounded-xl flex items-center gap-2 shadow-[0_0_20px_rgba(234,179,8,0.5)] animate-pulse font-bold text-lg border-2 border-yellow-300 z-10"
                        >
                          <Star size={24} className="fill-yellow-200" /> 
                          å¿…æ®ºæŠ€ï¼š{playerClass.ultimateName}
                        </button>
                    )}

                    {/* AI Battle Analysis Bar */}
                    <div className="w-full max-w-3xl bg-slate-800/50 border border-slate-600 rounded-lg p-2 flex items-center gap-2 text-xs md:text-sm text-slate-300 mt-12 md:mt-0">
                       <Activity size={16} className="text-green-400 animate-pulse" />
                       <span className="font-mono text-green-400 font-bold">T.A.S.</span>
                       <span>{getBattleAdvice()}</span>
                    </div>

                    <div className="text-yellow-400 font-bold font-mono tracking-widest text-sm bg-yellow-900/20 px-4 py-1 rounded-full border border-yellow-500/30">
                      æ­¦å™¨å……èƒ½ç¨‹åºå•Ÿå‹•
                    </div>
                    <h3 className="text-2xl md:text-3xl font-bold text-center text-slate-100">{currentQ.q}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl">
                      {currentQ.options.map((opt, idx) => (
                        <button 
                          key={idx}
                          onClick={() => handleAttack(opt.correct)}
                          className="bg-slate-800 hover:bg-slate-700 border-2 border-slate-700 hover:border-white p-6 rounded-xl text-lg font-bold transition-all hover:-translate-y-1 hover:shadow-lg text-slate-200"
                        >
                          {opt.text}
                        </button>
                      ))}
                    </div>
                    {/* Hint in Battle */}
                    <TAS_Hint hintText={currentQ.hint} />
                  </div>
                ) : (
                  <div className="flex-grow font-mono text-sm md:text-base space-y-3 p-6 h-64 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
                    {combatLog.map((log, i) => (
                      <div key={i} className={`p-3 rounded-lg border-l-4 animate-in fade-in slide-in-from-left-2 ${log.includes('[ä½ ]') ? 'border-green-500 bg-green-900/20' : log.includes('å¤§å¸') || log.includes('åšå£«') ? 'border-red-500 bg-red-900/20' : log.includes('[ç³»çµ±]') ? 'border-blue-500 bg-blue-900/20' : log.includes('é–ƒé¿') ? 'border-slate-500 bg-slate-800/80 text-slate-300' : 'border-slate-500 bg-slate-800/50'}`}>
                        {log}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          );
        }

        function VictoryScreen({ player, playerClass, weaponStats, onReset }) {
          return (
            <div className="text-center animate-zoom-in space-y-8 py-12">
              <div className="relative inline-block">
                <Trophy size={120} className="text-yellow-400 mx-auto drop-shadow-[0_0_30px_rgba(250,204,21,0.6)]" />
                <div className="absolute inset-0 bg-yellow-400 blur-3xl opacity-20"></div>
              </div>
              <h2 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-500">ä»»å‹™å®Œæˆï¼</h2>
              <div className="text-xl text-slate-300">
                <span className={`${playerClass.color} font-bold`}>{player.name}</span>ï¼Œä½ æˆåŠŸæ‹¯æ•‘äº†èƒ½æºæ ¸å¿ƒï¼<br/>
                {weaponStats.perfectCount === 3 ? (
                  <span className="text-purple-400 font-bold block mt-2 text-lg">âœ¨ å‚³å¥‡æˆå°±ï¼šæ“Šæ•—éš±è—é­”ç‹ âœ¨</span>
                ) : (
                  <span className="text-slate-500 text-sm">æç¤ºï¼šè©¦è‘—åœ¨å‡ç´šéšæ®µå…¨å°ï¼ŒæŒ‘æˆ°æ›´å¼·çš„æ•µäºº...</span>
                )}
              </div>
              <button onClick={onReset} className="inline-flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full transition-all mt-8 border border-slate-600">
                <RotateCcw size={20} /> è¿”å›ç¸½éƒ¨
              </button>
            </div>
          );
        }

        // --- Main App ---
        function Game() {
            const [gameState, setGameState] = useState('start'); 
            const [player, setPlayer] = useState({ name: '', classId: null, hp: 200, maxHp: 200 });
            const [inventory, setInventory] = useState([]); 
            const [weaponStats, setWeaponStats] = useState({ strength: 0, level: 1, perfectCount: 0 });
            const usedQuestionIds = useRef(new Set());

            const currentPlayerClass = CLASSES.find(c => c.id === player.classId) || CLASSES[0];

            const startGame = (name) => {
                setPlayer(p => ({ ...p, name }));
                setGameState('class_select');
            };

            const selectClass = (classId) => {
                setPlayer(p => ({ ...p, classId }));
                setGameState('level1');
            };

            const resetGame = () => {
                setGameState('start');
                setPlayer({ name: '', classId: null, hp: 200, maxHp: 200 });
                setInventory([]);
                setWeaponStats({ strength: 0, level: 1, perfectCount: 0 });
                usedQuestionIds.current = new Set(); 
            };

            const getUniqueQuestions = useCallback((count) => {
                const used = usedQuestionIds.current;
                const available = MASTER_QUESTION_POOL.filter(q => !used.has(q.id));
                let source = available;
                if (available.length < count) {
                    source = MASTER_QUESTION_POOL; 
                    usedQuestionIds.current = new Set();
                }
                const shuffled = [...source].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, count);
                selected.forEach(q => usedQuestionIds.current.add(q.id));
                return selected;
            }, []);

            return (
                <div className="min-h-screen bg-slate-950 text-cyan-50 font-sans selection:bg-cyan-500 selection:text-black overflow-hidden relative">
                    <div className="absolute inset-0 bg-[linear-gradient(to_right,#0f172a_1px,transparent_1px),linear-gradient(to_bottom,#0f172a_1px,transparent_1px)] bg-[size:4rem_4rem] pointer-events-none opacity-50"></div>
                    <div className="max-w-4xl mx-auto p-4 min-h-screen flex flex-col relative z-10">
                        {/* HUD */}
                        {gameState !== 'start' && gameState !== 'class_select' && (
                            <header className="flex flex-wrap justify-between items-center py-4 mb-6 bg-slate-900/80 backdrop-blur-md rounded-xl px-6 border-b border-white/10 shadow-lg transition-all duration-500">
                                <div className="flex items-center gap-4">
                                    <div className={`w-14 h-14 rounded-full border-2 ${currentPlayerClass.borderColor} overflow-hidden bg-slate-900 shadow-[0_0_15px_rgba(0,0,0,0.5)]`}>
                                        <currentPlayerClass.Avatar />
                                    </div>
                                    <div>
                                        <div className={`font-bold text-xl leading-none ${currentPlayerClass.color}`}>{player.name}</div>
                                        <div className="text-sm text-slate-400 flex items-center gap-1 mt-1">
                                            {currentPlayerClass.icon} {currentPlayerClass.name}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-4 items-center">
                                    {weaponStats.strength > 0 && (
                                        <div className="flex items-center gap-2 text-yellow-500 px-4 py-2 bg-yellow-900/20 border border-yellow-700/50 rounded-full font-mono font-bold animate-pulse">
                                            <Crosshair size={18} />
                                            <span>æˆ°åŠ›: {weaponStats.strength}</span>
                                        </div>
                                    )}
                                    <div className="flex items-center gap-2 px-4 py-2 bg-cyan-900/20 border border-cyan-700/50 rounded-full">
                                        <Package size={18} className="text-cyan-400" />
                                        <span className="font-mono">{inventory.length} é“å…·</span>
                                    </div>
                                </div>
                            </header>
                        )}

                        <main className="flex-grow flex flex-col justify-center">
                            {gameState === 'start' && <StartScreen onStart={startGame} />}
                            {gameState === 'class_select' && <ClassSelectScreen onSelect={selectClass} />}
                            {gameState === 'level1' && (
                                <Level1_Main 
                                    playerClass={currentPlayerClass} 
                                    getQuestions={getUniqueQuestions}
                                    onReset={resetGame}
                                    onComplete={(item) => {
                                        setInventory([item]);
                                        setGameState('level2');
                                    }} 
                                />
                            )}
                            {gameState === 'level2' && (
                                <Level2_Upgrade_Challenge 
                                    playerClass={currentPlayerClass}
                                    getQuestions={getUniqueQuestions}
                                    inventory={inventory}
                                    onComplete={(stats) => {
                                        setWeaponStats(stats);
                                        setGameState('boss_intro');
                                    }}
                                />
                            )}
                            {gameState === 'boss_intro' && (
                                <BossIntro 
                                    playerClass={currentPlayerClass}
                                    weaponStats={weaponStats}
                                    onStartBattle={() => setGameState('boss_battle')} 
                                />
                            )}
                            {gameState === 'boss_battle' && (
                                <BossBattle 
                                    player={player}
                                    playerClass={currentPlayerClass}
                                    weaponStats={weaponStats}
                                    getQuestions={getUniqueQuestions}
                                    onWin={() => setGameState('victory')} 
                                    onLose={resetGame} 
                                />
                            )}
                            {gameState === 'victory' && (
                                <VictoryScreen 
                                    player={player} 
                                    playerClass={currentPlayerClass}
                                    weaponStats={weaponStats}
                                    onReset={resetGame} 
                                />
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Game />);
    </script>
</body>
</html>
